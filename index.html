<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel 数据匹配与修改工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: Arial; 
            padding: 10px; 
            margin: 0 auto;
            max-width: 100%;
        }
        
        .control-panel { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 5px;
        }
        
        .file-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .file-input-group {
            flex: 1;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 字段容器布局 */
        .fields-container {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .match-fields,
        .update-fields {
            flex: 1;
            min-width: 300px;
        }
        

        .field-container {
            position: relative;
            margin: 0;  
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .field-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .field-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        .btn-add {
            padding: 2px 8px !important;
            font-size: 18px;
            line-height: 1;
            margin-left: 10px;
        }
        
        .btn-remove {
            padding: 2px 8px !important;
            font-size: 18px;
            line-height: 1;
        }
        
        .match-pair, .update-field-pair { 
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        
        .match-pair select, .update-field-pair select { 
            min-width: 150px;
            max-width: 200px;
            padding: 4px;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .left-panel, .right-panel {
            flex: 1;
            min-width: 300px;
        }
        
        /* 美化按钮样式 */
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-add, .btn-remove {
            padding: 2px 8px;
            font-size: 16px;
            line-height: 1;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        /* 美化字段选择区域 */
        .field-container {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        .field-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        /* 优化字段对的样式 */
        .match-pair, .update-field-pair {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .match-pair select, .update-field-pair select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        /* 表格样式优化 */
        .data-table-container {
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* 状态列样式 */
        .status-cell {
            text-align: center;
            white-space: nowrap;
            font-weight: bold;
        }
        
        .data-table tr:hover .status-cell {
            background-color: #f0f0f0;
        }
        
        /* 状态颜色样式补充 */
        .status-correct {
            color: #52c41a;
        }
        
        .status-error {
            color: #f5222d;
        }
        
        .status-unmatched {
            color: #faad14;
        }
        
        /* 匹配高亮样式 */
        .matched-row {
            background-color: #e6f7ff !important;
        }
        
        .highlight {
            background-color: #fff3e6 !important;
        }
        
        .modified {
            background-color: #f6ffed !important;
        }
        
        /* 控制面板样式优化 */
        .control-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        /* 字段对操作按钮容器 */
        .field-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-legend {
            margin: 10px 0;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .data-table-container {
                overflow-x: auto;
            }
            
            .data-table {
                min-width: 600px;
            }
            
            /* 字段容器布局 */
            .fields-container {
                flex-direction: column;
            }
            
            .match-fields,
            .update-fields {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<h2>Excel 数据匹配与修改工具</h2>

<div class="control-panel">
    <div class="file-inputs">
        <div class="file-input-group">
            <label for="file1">数据来源(源表):</label>
            <input type="file" id="file1" accept=".xls,.xlsx" title="选择源数据Excel文件">
            <select id="sheet1" class="sheet-select" title="选择工作表">
                <option value="">选择工作表</option>
            </select>
        </div>
        <div class="file-input-group">
            <label for="file2">修改表单(目标表):</label>
            <input type="file" id="file2" accept=".xls,.xlsx" title="选择目标Excel文件">
            <select id="sheet2" class="sheet-select" title="选择工作表">
                <option value="">选择工作表</option>
            </select>
        </div>
    </div>
    
    <div class="fields-container">
        <div class="field-container match-fields">
            <div class="field-header">
                <label>表单匹配字段:</label>
                <button type="button" class="btn btn-secondary btn-add" onclick="addMatchPair()">增加匹配字段 +</button>
            </div>
            <div id="matchPairs">
                <!-- 匹配字段会在这里动态添加 -->
            </div>
        </div>
        
        <div class="field-container update-fields">
            <div class="field-header">
                <label>表单修改字段:</label>
                <button type="button" class="btn btn-secondary btn-add" onclick="addUpdateField()">增加修改字段 +</button>
            </div>
            <div id="updateFields">
                <!-- 修改字段会在这里动态添加 -->
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <button class="btn" onclick="startMatch()">开始数据匹配</button>
        <button class="btn" onclick="applyAllChanges()">一键应用所有修改</button>
        <button class="btn btn-secondary" onclick="exportExcel()">导出Excel</button>
    </div>
</div>

<div class="container">
    <div class="left-panel">
        <h3>数据源表单预览：</h3>
        <div class="status-legend">
            状态说明：✅ 正确 | ❌ 异常 | ⛔ 未匹配
        </div>
        <div id="table1Container"></div>
    </div>
    
    <div class="right-panel">
        <h3>修改表单数据预览（实时更新）：</h3>
        <div class="status-legend">
            状态说明：✅ 正确 | ❌ 异常 | ⛔ 未匹配
        </div>
        <div id="table2Container"></div>
    </div>
</div>

<div id="diffPanel">
    <h3>需要修改的记录：</h3>
    <div id="resultTableContainer"></div>
</div>

<script>
let data1 = [], data2 = [];
let headers1 = [], headers2 = [];
let workbook1 = null, workbook2 = null;

function readExcel(file, isFirstFile) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            if (isFirstFile) {
                workbook1 = workbook;
                updateSheetList(workbook, 'sheet1');
            } else {
                workbook2 = workbook;
                updateSheetList(workbook, 'sheet2');
            }
            resolve(workbook);
        };
        reader.readAsArrayBuffer(file);
    });
}

function updateSheetList(workbook, selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = workbook.SheetNames.map(name => 
        `<option value="${name}">${name}</option>`
    ).join('');
    
    // 触发sheet变更事件
    if (selectId === 'sheet1') {
        loadSheetData(workbook, select.value, true);
    } else {
        loadSheetData(workbook, select.value, false);
    }
}

function excelDateToJSDate(serial) {
    if (!serial || isNaN(serial)) return serial;
    const utc_days  = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;                                        
    const date_info = new Date(utc_value * 1000);
    const fractional_day = serial - Math.floor(serial) + 0.0000001;
    let total_seconds = Math.floor(86400 * fractional_day);
    const seconds = total_seconds % 60;
    total_seconds -= seconds;
    const hours = Math.floor(total_seconds / (60 * 60));
    const minutes = Math.floor(total_seconds / 60) % 60;
    return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
}

function loadSheetData(workbook, sheetName, isFirstFile) {
    const sheet = workbook.Sheets[sheetName];
    const range = XLSX.utils.decode_range(sheet['!ref']); // 获取表格范围
    const maxCol = range.e.c; // 最大列数
    
    const data = [];
    // 遍历每一行
    for(let R = range.s.r; R <= range.e.r; R++) {
        const row = new Array(maxCol + 1).fill(''); // 预填充空字符串
        // 遍历每一列
        for(let C = range.s.c; C <= range.e.c; C++) {
            const cell_ref = XLSX.utils.encode_cell({r: R, c: C});
            const cell = sheet[cell_ref];
            if(cell) { // 如果单元格存在
                let value = cell.v;
                // 处理日期
                if(cell.t === 'n' && !isNaN(value)) {
                    const possibleDate = excelDateToJSDate(value);
                    if (possibleDate && possibleDate.getFullYear() > 1900 && possibleDate.getFullYear() < 2100) {
                        value = possibleDate.toLocaleDateString('zh-CN');
                    }
                }
                row[C] = value;
            }
        }
        data.push(row);
    }
    
    if (isFirstFile) {
        data1 = data;
        headers1 = data[0] || [];
    } else {
        data2 = data;
        headers2 = data[0] || [];
    }
    
    displayTable(data, isFirstFile ? 'table1Container' : 'table2Container');
    updateMatchFieldsUI();
}

// 更新原有的事件监听器
document.getElementById('file1').addEventListener('change', async (e) => {
    await readExcel(e.target.files[0], true);
});

document.getElementById('file2').addEventListener('change', async (e) => {
    await readExcel(e.target.files[0], false);
});

document.getElementById('sheet1').addEventListener('change', (e) => {
    loadSheetData(workbook1, e.target.value, true);
});

document.getElementById('sheet2').addEventListener('change', (e) => {
    loadSheetData(workbook2, e.target.value, false);
});

function displayTable(data, containerId) {
    if (!data || !data.length) return;
    
    let html = '<div class="data-table-container"><table class="data-table">';
    html += '<tr><th>状态</th>' + data[0].map(h => `<th>${h || ''}</th>`).join('') + '</tr>';
    
    for (let i = 1; i < data.length; i++) {
        let status = '⛔';
        let statusClass = 'status-unmatched';
        
        if (changes.length > 0 || window.matchedKeys) {
            const currentKey = getMatchKey(data[i], containerId === 'table1Container');
            
            if (containerId === 'table1Container') {
                // 数据源表单状态逻辑
                if (window.matchedKeys && window.matchedKeys.has(currentKey)) {
                    // 检查是否有需要修改的值
                    const hasChanges = changes.some(change => 
                        getMatchKey(data2[change.rowIndex], false) === currentKey
                    );
                    status = hasChanges ? '❌' : '✅';
                    statusClass = hasChanges ? 'status-error' : 'status-correct';
                } else {
                    status = '⛔';
                    statusClass = 'status-unmatched';
                }
            } else {
                // 修改表单状态逻辑
                if (window.matchedKeys && window.matchedKeys.has(currentKey)) {
                    const matchingChange = changes.find(c => c.rowIndex === i);
                    if (matchingChange) {
                        status = '❌';
                        statusClass = 'status-error';
                    } else {
                        status = '✅';
                        statusClass = 'status-correct';
                    }
                } else {
                    status = '⛔';
                    statusClass = 'status-unmatched';
                }
            }
        }
        
        html += `<tr class="data-row">
            <td class="status-cell ${statusClass}">${status}</td>` + 
            data[i].map(cell => `<td>${cell || ''}</td>`).join('') + 
        '</tr>';
    }
    
    html += '</table></div>';
    document.getElementById(containerId).innerHTML = html;
}

// 辅助函数：根据匹配字段获取匹配键
function getMatchKey(row, isSourceTable) {
    const matchPairs = Array.from(document.getElementsByClassName('match-pair')).map(pair => ({
        index1: parseInt(pair.querySelector('.field1').value),
        index2: parseInt(pair.querySelector('.field2').value)
    })).filter(pair => !isNaN(pair.index1) && !isNaN(pair.index2));
    
    return matchPairs.map(p => row[isSourceTable ? p.index1 : p.index2]).join('||');
}

let changes = [];

function startMatch() {
    if (!data1.length || !data2.length) return alert('请先上传两个文件');
    
    // 获取所有匹配对
    const matchPairs = Array.from(document.getElementsByClassName('match-pair')).map(pair => ({
        index1: parseInt(pair.querySelector('.field1').value),
        index2: parseInt(pair.querySelector('.field2').value)
    })).filter(pair => !isNaN(pair.index1) && !isNaN(pair.index2));
    
    if(!matchPairs.length) return alert('请至少设置一个匹配字段对');
    
    // 获取所有要修改的字段对
    const updatePairs = Array.from(document.getElementsByClassName('update-field-pair')).map(pair => ({
        sourceIndex: parseInt(pair.querySelector('.source-field').value),
        targetIndex: parseInt(pair.querySelector('.target-field').value)
    })).filter(pair => !isNaN(pair.sourceIndex) && !isNaN(pair.targetIndex));
    
    if(!updatePairs.length) return alert('请至少选择一个要修改的字段对');
    
    changes = [];
    const map = new Map();
    
    // 构建匹配映射
    for(let i = 1; i < data1.length; i++) {
        const matchKey = matchPairs.map(p => data1[i][p.index1]).join('||');
        if(matchKey.trim()) {
            // 存储每个匹配键对应的所有要更新字段的值
            const updateValues = {};
            updatePairs.forEach(pair => {
                updateValues[pair.targetIndex] = data1[i][pair.sourceIndex];
            });
            map.set(matchKey, updateValues);
        }
    }
    
    // 查找差异
    const result = [];
    const matched = new Set(); // 记录已匹配的键
    
    for(let i = 1; i < data2.length; i++) {
        const matchKey = matchPairs.map(p => data2[i][p.index2]).join('||');
        if(matchKey.trim()) {
            const sourceVals = map.get(matchKey);
            if (sourceVals) {
                matched.add(matchKey); // 记录匹配的键
                const changes = [];
                updatePairs.forEach(pair => {
                    const oldVal = data2[i][pair.targetIndex];
                    const newVal = sourceVals[pair.targetIndex];
                    if(oldVal !== newVal) {
                        changes.push({
                            field: headers2[pair.targetIndex],
                            oldVal: oldVal,
                            newVal: newVal
                        });
                    }
                });
                
                if(changes.length > 0) {
                    const row = [...data2[i]];
                    changes.forEach(change => {
                        row.push(`${change.field}: ${change.oldVal} → ${change.newVal}`);
                    });
                    result.push({
                        rowIndex: i,
                        matchKey: matchKey,
                        row: row,
                        changes: changes
                    });
                }
            }
        }
    }
    
    changes = result;
    window.matchedKeys = matched; // 存储匹配的键以供其他函数使用
    
    displayMultiFieldResults(result);
    highlightMultiFieldDifferences(result);
    displayTable(data1, 'table1Container');
    displayTable(data2, 'table2Container');
}

function displayMultiFieldResults(results) {
    let html = '<table><tr>';
    if(results.length > 0 && results[0].row) {
        const headers = [...headers2, '修改详情'];
        headers.forEach(h => html += `<th>${h}</th>`);
        html += `<th>操作</th></tr>`;

        results.forEach((result, index) => {
            html += '<tr class="diff-row">';
            result.row.forEach(cell => html += `<td>${cell || ''}</td>`);
            html += `<td>
                        <button class="btn" onclick="applyMultiChanges(${index})">应用修改</button>
                    </td></tr>`;
        });
    }
    html += '</table>';
    document.getElementById('resultTableContainer').innerHTML = html;
}

// 应用多字段修改
function applyMultiChanges(index) {
    const result = changes[index];
    
    // 应用修改
    result.changes.forEach(change => {
        const updateIdx = headers2.indexOf(change.field);
        data2[result.rowIndex][updateIdx] = change.newVal;
    });
    
    // 从变更集合中移除
    const matchKey = result.matchKey;
    changes.splice(index, 1);
    
    // 如果该行没有其他需要修改的内容,则从matchedKeys中移除
    if (!changes.some(c => getMatchKey(data2[c.rowIndex], false) === matchKey)) {
        // 保持匹配状态但标记为正确
        if (window.matchedKeys) {
            window.matchedKeys.add(matchKey);
        }
    }
    
    // 更新表格显示
    displayTable(data2, 'table2Container');
    displayTable(data1, 'table1Container');
    
    // 更新差异显示
    displayMultiFieldResults(changes);
    highlightMultiFieldDifferences(changes);
}

// 高亮显示多字段差异
function highlightMultiFieldDifferences(results) {
    const tables = document.querySelectorAll('#table2Container .data-table tr');
    
    // 重置所有高亮
    tables.forEach(row => {
        row.classList.remove('matched-row');
        const cells = row.getElementsByTagName('td');
        Array.from(cells).forEach(cell => {
            cell.classList.remove('highlight', 'modified');
        });
    });

    // 更新所有行的状态
    for(let i = 1; i < tables.length; i++) {
        const statusCell = tables[i].querySelector('.status-cell');
        if(statusCell) {
            const rowIndex = i;
            if(results.some(r => r.rowIndex === rowIndex)) {
                statusCell.textContent = '❌';
                statusCell.classList.add('status-error');
            } else {
                statusCell.textContent = '✅';
                statusCell.classList.add('status-correct');
            }
        }
    }

    // 添加新的高亮
    results.forEach(result => {
        const row = tables[result.rowIndex];
        if (row) {
            row.classList.add('matched-row');
            result.changes.forEach(change => {
                const updateIdx = headers2.indexOf(change.field);
                const cells = row.getElementsByTagName('td');
                if (cells[updateIdx + 1]) { // +1 因为添加了状态列
                    cells[updateIdx + 1].classList.add('highlight');
                }
            });
        }
    });
}

function exportExcel() {
    // 获取原始的工作簿和工作表
    const originalWorkbook = workbook2;
    const sheetName = document.getElementById('sheet2').value;
    
    // 创建新的工作簿，并复制原工作簿的所有内容
    const newWorkbook = XLSX.utils.book_new();
    
    // 遍历原工作簿中的所有工作表
    originalWorkbook.SheetNames.forEach(name => {
        if (name === sheetName) {
            // 对于需要修改的工作表，只更新修改的单元格
            const sheet = originalWorkbook.Sheets[name];
            const newSheet = { ...sheet }; // 复制原工作表
            
            // 只更新修改过的单元格
            changes.forEach(result => {
                result.changes.forEach(change => {
                    const updateIdx = headers2.indexOf(change.field);
                    const cellRef = XLSX.utils.encode_cell({ r: result.rowIndex, c: updateIdx });
                    newSheet[cellRef] = { 
                        t: typeof change.newVal === 'number' ? 'n' : 's',
                        v: change.newVal 
                    };
                });
            });
            
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, name);
        } else {
            // 对于其他工作表，直接复制
            const sheet = originalWorkbook.Sheets[name];
            XLSX.utils.book_append_sheet(newWorkbook, sheet, name);
        }
    });
    
    // 获取原文件名
    const originalFileName = document.getElementById('file2').files[0]?.name || 'data';
    const baseName = originalFileName.replace(/\.(xlsx|xls)$/, '');
    const newFileName = `${baseName}_修正版.xlsx`;
    
    // 导出时保持原有格式
    XLSX.writeFile(newWorkbook, newFileName, {
        bookType: 'xlsx',
        bookSST: false,
        type: 'binary',
        cellStyles: true,
        compression: true
    });
}

function updateFieldsUI() {
    const matchDiv = document.getElementById('matchFields');
    const updateSelect = document.getElementById('updateField');
    matchDiv.innerHTML = '';
    updateSelect.innerHTML = '<option value="">请选择字段</option>';

    if (headers1.length && headers2.length) {
        // 找出两个表共有的列头
        const commonHeaders = headers1.filter(h => headers2.includes(h));
        
        // 为每个匹配字段创建复选框
        commonHeaders.forEach((header, idx) => {
            const index1 = headers1.indexOf(header);
            const index2 = headers2.indexOf(header);
            if (header) {
                const chk = `<label style="margin-right:10px;">
                    <input type="checkbox" 
                           class="matchField" 
                           value="${index1}" 
                           data-index2="${index2}"
                           title="选择匹配字段">
                    ${header}
                </label>`;
                matchDiv.innerHTML += chk;
            }
        });

        // 更新可修改字段列表
        headers2.forEach((header, idx) => {
            if (header) {
                updateSelect.innerHTML += `<option value="${idx}">${header}</option>`;
            }
        });
    }
}

// 添加匹配字段对
function addMatchPair() {
    const container = document.getElementById('matchPairs');
    const pairDiv = document.createElement('div');
    pairDiv.className = 'match-pair';
    
    // 创建表1字段选择器
    const select1 = document.createElement('select');
    select1.className = 'field1';
    select1.title = '表1字段';
    select1.innerHTML = '<option value="">选择源表字段</option>';
    headers1.forEach((header, idx) => {
        if(header) {
            select1.innerHTML += `<option value="${idx}">${header}</option>`;
        }
    });
    
    // 创建表2字段选择器
    const select2 = document.createElement('select');
    select2.className = 'field2';
    select2.title = '表2字段';
    select2.innerHTML = '<option value="">选择目标表字段</option>';
    headers2.forEach((header, idx) => {
        if(header) {
            select2.innerHTML += `<option value="${idx}">${header}</option>`;
        }
    });
    
    // 创建按钮容器
    const btnContainer = document.createElement('div');
    btnContainer.className = 'field-actions';
    
    // 创建删除按钮
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-secondary btn-remove';
    removeBtn.textContent = '-';
    removeBtn.onclick = function() {
        if(container.children.length > 1) {
            pairDiv.remove();
        }
    };
    
    btnContainer.appendChild(removeBtn);
    
    pairDiv.appendChild(select1);
    pairDiv.appendChild(document.createTextNode('对应'));
    pairDiv.appendChild(select2);
    pairDiv.appendChild(btnContainer);
    
    container.appendChild(pairDiv);
}

// 添加修改字段对
function addUpdateField() {
    const container = document.getElementById('updateFields');
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'update-field-pair';
    
    // 创建源表字段选择器
    const sourceSelect = document.createElement('select');
    sourceSelect.className = 'source-field';
    sourceSelect.title = '源表字段';
    sourceSelect.innerHTML = '<option value="">选择源表字段</option>';
    headers1.forEach((header, idx) => {
        if(header) {
            sourceSelect.innerHTML += `<option value="${idx}">${header}</option>`;
        }
    });
    
    // 创建目标表字段选择器
    const targetSelect = document.createElement('select');
    targetSelect.className = 'target-field';
    targetSelect.title = '目标表字段';
    targetSelect.innerHTML = '<option value="">选择目标表字段</option>';
    headers2.forEach((header, idx) => {
        if(header) {
            targetSelect.innerHTML += `<option value="${idx}">${header}</option>`;
        }
    });
    
    // 创建按钮容器
    const btnContainer = document.createElement('div');
    btnContainer.className = 'field-actions';
    
    // 创建删除按钮
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-secondary btn-remove';
    removeBtn.textContent = '-';
    removeBtn.onclick = function() {
        if(container.children.length > 1) {
            fieldDiv.remove();
        }
    };
    
    btnContainer.appendChild(removeBtn);
    
    fieldDiv.appendChild(sourceSelect);
    fieldDiv.appendChild(document.createTextNode('➡'));
    fieldDiv.appendChild(targetSelect);
    fieldDiv.appendChild(btnContainer);
    
    container.appendChild(fieldDiv);
}

// 更新字段选择下拉框
function updateFieldSelects() {
    const field1Selects = document.querySelectorAll('.field1');
    const field2Selects = document.querySelectorAll('.field2');
    
    field1Selects.forEach(select => {
        select.innerHTML = headers1.map((h, idx) => 
            `<option value="${idx}">${h}</option>`
        ).join('');
    });
    
    field2Selects.forEach(select => {
        select.innerHTML = headers2.map((h, idx) => 
            `<option value="${idx}">${h}</option>`
        ).join('');
    });
}

// 删除匹配字段对
document.getElementById('matchPairs').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-pair')) {
        const pairDiv = e.target.closest('.match-pair');
        pairDiv.remove();
    }
});

// 添加相关JavaScript函数
function updateMatchFieldsUI() {
    const matchContainer = document.getElementById('matchPairs');
    const updateContainer = document.getElementById('updateFields');
    
    matchContainer.innerHTML = ''; // 清空现有内容
    updateContainer.innerHTML = ''; // 清空现有内容
    
    addMatchPair(); // 添加第一个匹配对
    addUpdateField(); // 添加第一个修改字段
}
</script>
</body>
</html>